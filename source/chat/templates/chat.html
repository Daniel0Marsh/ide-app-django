{% extends 'base.html' %}
{% block title %} {{ room_name }} {% endblock %}

{% block extra_head %}
    {% load static %}
    <link rel="stylesheet" type="text/css" href="{% static 'chat.css' %}">
    <script src="{% static 'chat.js' %}"></script>
{% endblock %}

{% block content %}
<!-- Main Content -->
<div class="card">
    <div class="card-header">
    <div class="d-flex align-items-center">
        <img src="{{ recipient.profile_picture.url }}" alt="Profile" class="rounded-circle me-2" style="width: 40px; height: 40px;">
        <!-- Make the username clickable to the profile -->
        <a href="{% url 'public_profile' recipient.username %}" class="text-light">{{ recipient.username }}</a>
    </div>
    </div>
    <div class="card-body">
        <div id="chat-log" class="p-3 mb-3" style="height: 500px; overflow-y: scroll;">
            <!-- Messages will appear here -->
            {% for message in messages %}
                <div class="message-item {% if message.sender == request.user %}sender{% else %}receiver{% endif %}">
                    <img class="profile-img" src="{{ message.sender.profile_picture.url }}" alt="Profile">
                    <div class="message-content">
                        <div class="user-name">
                            {{ message.sender.username }}
                            <span class="timestamp">{{ message.timestamp }}</span>
                        </div>
                        <div class="message-bubble">{{ message.content }}</div>
                    </div>
                </div>
            {% endfor %}
        </div>
        <div class="input-group">
            <input id="chat-message-input" type="text" class="form-control bg-dark text-light" aria-label="Message">
            <button id="chat-message-submit" class="btn btn-secondary">Send</button>
        </div>
    </div>
</div>

<script>
// Pass the logged-in user's username from Django to JavaScript
const loggedInUsername = "{{ request.user.username|escapejs }}";
const roomName = "{{ room_name|escapejs }}";
const chatSocket = new WebSocket(
    `ws://${window.location.host}/ws/chat/${roomName}/`
);

chatSocket.onmessage = function(e) {
    const data = JSON.parse(e.data);
    const chatLog = document.querySelector('#chat-log');

    // Create message item container
    const messageItem = document.createElement('div');
    messageItem.classList.add('message-item');

    // Add the appropriate CSS class based on sender
    if (data.sender === loggedInUsername) {
        messageItem.classList.add('sender');
    } else {
        messageItem.classList.add('receiver');
    }

    // User's profile picture
    const profileImg = document.createElement('img');
    profileImg.classList.add('profile-img');
    profileImg.src = data.profile_image_url;

    // Message content container
    const messageContent = document.createElement('div');
    messageContent.classList.add('message-content');

    // User's name bubble
    const userName = document.createElement('span');
    userName.classList.add('user-name');
    userName.textContent = data.sender;

    // Timestamp bubble
    const timestamp = document.createElement('span');
    timestamp.classList.add('timestamp');
    timestamp.textContent = data.timestamp;  // Display timestamp

    // Message bubble
    const messageBubble = document.createElement('div');
    messageBubble.classList.add('message-bubble');
    messageBubble.textContent = data.message;

    // Append username and timestamp to message content
    const usernameContainer = document.createElement('div');
    usernameContainer.appendChild(userName);
    usernameContainer.appendChild(timestamp);

    messageContent.appendChild(usernameContainer);
    messageContent.appendChild(messageBubble);

    // Append profile image and message content to message item
    messageItem.appendChild(profileImg);
    messageItem.appendChild(messageContent);

    chatLog.appendChild(messageItem);

    // Auto-scroll to the latest message
    chatLog.scrollTop = chatLog.scrollHeight;
};

chatSocket.onclose = function(e) {
    console.error('Chat socket closed unexpectedly');
};

// Function to send the message
function sendMessage() {
    const messageInputDom = document.querySelector('#chat-message-input');
    const message = messageInputDom.value;
    chatSocket.send(JSON.stringify({
        'message': message,
        'sender': loggedInUsername, // Include sender info
    }));
    messageInputDom.value = ''; // Clear input after sending
}

// Send message on button click
document.querySelector('#chat-message-submit').onclick = function(e) {
    sendMessage();
};

// Send message on Enter key press
document.querySelector('#chat-message-input').addEventListener('keypress', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) { // Check if Enter is pressed (without Shift key for multi-line input)
        e.preventDefault(); // Prevent the default behavior (line break)
        sendMessage();
    }
});
</script>

{% endblock %}

