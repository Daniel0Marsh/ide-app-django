<html lang="en">
<head>
    <link rel="icon" type="image/png" href="{{ favicon.favicon.url }}" />
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %} {{current_project.project_name}}/{{file_name}} {% endblock %}</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">

    {% load static %}
    <link rel="stylesheet" type="text/css" href="{% static 'ide.css' %}">
    <script src="{% static ide.js %}"></script>
</head>

<body>

<!-- project side-nav -->
<div class="side-nav shadow-end border-end border-dark">
    <!-- Git Branch Dropdown (aligned to the right) -->
    {% if request.user == current_project.user or request.user in current_project.collaborators.all %}
    <div class="dropend p-0 m-0 ms-auto" data-bs-theme="dark">
        <button class="btn mx-auto btn-dark mb-2 mt-2" type="button" id="gitBranchDropdown" data-bs-toggle="dropdown" aria-expanded="false"
            title="Menu">
            <i class="bi bi-three-dots-vertical fs-5 text-light"></i>
        </button>
        <ul class="dropdown-menu" aria-labelledby="gitBranchDropdown">
            {% if is_git_repo %}
                <li>
                    <span class="dropdown-item-text fw-bold">
                        Branch: {{branch}}
                    </span>
                </li>
                <li>
                    <hr class="dropdown-divider">
                </li>
                <li>
                    <a class="dropdown-item" data-bs-toggle="modal" data-bs-target="#branchModal">
                        <i class="bi bi-shift"></i> Switch Branch
                    </a>
                </li>
                <li>
                    <button class="dropdown-item" type="submit" name="pull_and_update_files">
                        <i class="bi bi-arrow-repeat"></i> Pull
                    </button>
                </li>
                <li>
                    <button class="dropdown-item" type="submit" name="push_all_commits">
                        <i class="bi bi-arrow-90deg-up"></i> Push
                    </button>
                </li>
                <li>
                    <button class="dropdown-item" type="submit" name="commit_files">
                        <i class="bi bi-file-earmark-text"></i> Commit
                    </button>
                </li>
                <li>
                    <hr class="dropdown-divider">
                </li>
            {% endif %}
            <li>
                <button type="button" class="dropdown-item" title="Theme" data-bs-toggle="modal"
                        data-bs-target="#colorChangeModal">
                    <i class="bi bi-paint-bucket fs-5 text-light"></i> Syntax
                </button>
            </li>
            <li>
                <a class="dropdown-item" data-bs-toggle="tooltip" title="Home"
                   href="{% url 'project' username=current_project.user.username project_id=current_project.id %}">
                    <i class="bi bi-house fs-5 text-light"></i> Project Home
                </a>
            </li>
        </ul>
    </div>
    {% endif %}
    <button type="button" class="btn mx-auto btn-dark mb-2 mt-2" id="sidebarCollapse" data-bs-toggle="tooltip"
            title="Project">
        <i class="bi bi-folder2-open fs-5 text-light"></i>
    </button>
    {% if request.user == current_project.user or request.user in current_project.collaborators.all %}
    <button type="button" class="btn mx-auto btn-dark mb-2 mt-2" id="gitSidebarCollapse" data-bs-toggle="tooltip"
            title="Git Commits">
        <i class="bi bi-git fs-5 text-light"></i>
    </button>
    <button type="button" class="btn mx-auto btn-dark mb-2 mt-2" id="taskSidebarCollapse" data-bs-toggle="tooltip"
            title="Tasks">
        <i class="bi bi-card-checklist fs-5 text-light"></i>
    </button>
    <button type="button" class="btn mx-auto btn-dark mb-2 mt-2" title="Terminal" data-bs-toggle="offcanvas"
            data-bs-target="#offcanvasBottom"
            aria-controls="offcanvasBottom">
        <i class="bi bi-terminal fs-5 text-light"></i>
    </button>
    {% endif %}
</div>

<!-- Project Tree Form -->
<form method="post" enctype="multipart/form-data"
      action="{% url 'ide' username=current_project.user.username project_id=current_project.id %}"
      class="sidebar shadow border-end border-dark" id="filesSidebar" style="height: 100vh; overflow-y: auto;">
    {% csrf_token %}
    <div class="px-3 py-2">
        <h5 class="text-light">Project Files</h5>
        <hr class="border-secondary">

        <!-- Project Tree -->
        <ul class="list-unstyled">
            {% for node in project_tree %}
            <li>
                {% if node.type == 'directory' %}
                <!-- Directory -->
                <button class="btn btn-sm folder-btn" type="button" data-bs-toggle="collapse"
                        data-bs-target="#{{ node.name|slugify }}" aria-expanded="true"
                        aria-controls="{{ node.name|slugify }}">
                    <i class="bi bi-folder"></i><i class="bi bi-folder-minus d-none"></i> {{ node.name }}
                </button>
                <ul class="collapse show list-unstyled ms-4" id="{{ node.name|slugify }}">
                    {% for child in node.children %}
                    <li>
                        {% if child.type == 'directory' %}
                        <!-- Subdirectory -->
                        <button class="btn btn-sm folder-btn" type="button" data-bs-toggle="collapse"
                                data-bs-target="#{{ child.name|slugify }}" aria-expanded="true"
                                aria-controls="{{ child.name|slugify }}">
                            <i class="bi bi-folder"></i><i class="bi bi-folder-minus d-none"></i> {{ child.name }}
                        </button>
                        <ul class="collapse show list-unstyled ms-4" id="{{ child.name|slugify }}">
                            {% for grandchild in child.children %}
                            {% if grandchild.type == 'file' %}
                            <!-- File in Subdirectory -->
                            <li>
                                <button class="btn btn-sm file-item" type="submit" name="open_file"
                                        value="{{ grandchild.path }}">
                                    <i class="bi bi-file-earmark-code"></i> {{ grandchild.name }}
                                </button>
                            </li>
                            {% endif %}
                            {% endfor %}
                        </ul>
                        {% elif child.type == 'file' %}
                        <!-- File -->
                        <button class="btn btn-sm file-item" type="submit" name="open_file"
                                value="{{ child.path }}">
                            <i class="bi bi-file-earmark-code"></i> {{ child.name }}
                        </button>
                        {% endif %}
                    </li>
                    {% endfor %}
                </ul>
                {% elif node.type == 'file' %}
                <!-- Root-Level File -->
                <button class="btn btn-sm file-item" type="submit" name="open_file"
                        value="{{ node.path }}">
                    <i class="bi bi-file-earmark-code"></i> {{ node.name }}
                </button>
                {% endif %}
            </li>
            {% endfor %}
        </ul>
    </div>
</form>

<!-- Task Sidebar -->
<div class="sidebar shadow border-end border-dark" id="tasksSidebar" style="height: 100vh; overflow-y: auto;">
    <div class="px-3 py-2">
        <h5 class="text-light">Project Tasks</h5>
        <hr class="border-secondary">

        {% if tasks %}
        <!-- Task List -->
        <ul class="list-group list-group-flush">
            {% for task in tasks %}
            <li class="list-group-item bg-transparent border-secondary text-light">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <!-- Task Title -->
                    <a href="#"
                       class="text-decoration-none text-light fw-bold"
                       data-bs-toggle="modal"
                       data-bs-target="#updateTaskModal"
                       data-task-id="{{ task.id }}"
                       data-task-title="{{ task.title }}"
                       data-task-description="{{ task.description }}"
                       data-task-status="{{ task.status }}">
                        {{ task.title }}
                    </a>
                    <!-- Task Status Badge -->
                    <span class="badge bg-secondary">
                        {{ task.get_status_display }}
                    </span>
                </div>
                <!-- Task Details -->
                <p class="mb-1">{{ task.description }}</p>
                <div class="small">
                    <span>Assigned to: <strong>{{ task.assigned_to.username }}</strong></span><br>
                    <span>Assigned by: <strong>{{ task.assigned_by.username }}</strong></span>
                </div>
            </li>
            {% endfor %}
        </ul>
        {% else %}
        <!-- No Tasks Message -->
        <div class="text-center py-5">
            <p class="text-light">No tasks have been assigned to this project yet.</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Git Commits Sidebar -->
<div class="sidebar shadow border-end border-dark" id="gitCommitsSidebar" style="height: 100vh; overflow-y: auto;">
    {% if is_git_repo %}
    <div class="px-3 py-2">
        <h5 class="text-light">Git Commits</h5>
        <hr class="border-secondary">

        <form method="POST" action="">
            {% csrf_token %}

            <div class="mb-0 d-flex flex-column">
                <div class="mb-5">
                    <!-- Uncommitted (UNTRACKED) Files Section -->
                    <div class="card btn-dark text-light border-secondary p-1">
                        <div class="d-flex align-items-center text-light border-secondary">
                            <button class="btn btn-dark text-light p-0 me-2" type="button" data-bs-toggle="collapse" data-bs-target="#uncommitted-files-untracked-section" aria-controls="uncommitted-files-untracked-section">
                                <i class="bi bi-chevron-down"></i>
                            </button>
                            <label for="select-all-files-untracked" class="form-check-label text-light mb-0">
                                <input type="checkbox" class="form-check-input" id="select-all-files-untracked" checked>
                                Untracked Files
                            </label>
                        </div>
                    </div>
                    <div class="collapse show" id="uncommitted-files-untracked-section">
                        <ul class="list-group">
                            {% for file in uncommitted_files %}
                                {% if file.change_type == 'Untracked' %}
                                <li class="list-group-item bg-transparent border-0 text-light p-0 ms-3 d-flex align-items-center">
                                    <input type="checkbox" class="form-check-input me-2" name="selected_files" value="{{ file.file }}" id="file-untracked-{{ forloop.counter }}" checked>
                                    <form method="POST" action="" class="form-inline mb-0 d-flex align-items-center">
                                        {% csrf_token %}
                                        <button class="btn btn-sm file-item" for="file-untracked-{{ forloop.counter }}" type="submit" name="open_file" value="{{current_project.project_path}}/{{ file.file }}">
                                            <strong title="{{ file.file }}">{{ file.file }}</strong>
                                            <span class="badge bg-danger ms-2">{{ file.change_type }}</span>
                                        </button>
                                    </form>
                                </li>
                                {% endif %}
                            {% empty %}
                            <li class="list-group-item bg-transparent border-0 text-light p-0 ms-3">No uncommitted files available.</li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>

                <!-- Uncommitted (TRACKED) Files Section -->
                <div class="mb-5">
                    <div class="card btn-dark text-light border-secondary p-1">
                        <div class="d-flex align-items-center text-light border-secondary">
                            <button class="btn btn-dark text-light p-0 me-2" type="button" data-bs-toggle="collapse" data-bs-target="#uncommitted-files-tracked-section" aria-controls="uncommitted-files-tracked-section">
                                <i class="bi bi-chevron-down"></i>
                            </button>
                            <label for="select-all-files-tracked" class="form-check-label text-light mb-0">
                                <input type="checkbox" class="form-check-input" id="select-all-files-tracked" checked>
                                Changes
                            </label>
                        </div>
                    </div>
                    <div class="collapse show" id="uncommitted-files-tracked-section">
                        <ul class="list-group">
                            {% for file in uncommitted_files %}
                                {% if file.change_type != 'Untracked' %}
                                <li class="list-group-item bg-transparent border-0 text-light p-0 ms-3 d-flex align-items-center">
                                    <input type="checkbox" class="form-check-input me-2" name="selected_files" value="{{ file.file }}" id="file-tracked-{{ forloop.counter }}" checked>
                                    <form method="POST" action="" class="form-inline mb-0 d-flex align-items-center">
                                        {% csrf_token %}
                                        <button class="btn btn-sm file-item" for="file-tracked-{{ forloop.counter }}" type="submit" name="open_file" value="{{current_project.project_path}}/{{ file.file }}">
                                            <strong title="{{ file.file }}">{{ file.file }}</strong>
                                            <span class="badge bg-danger ms-2">{{ file.change_type }}</span>
                                        </button>
                                    </form>
                                </li>
                                {% endif %}
                            {% empty %}
                            <li class="list-group-item bg-transparent border-0 text-light p-0 ms-3">No Changes</li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>

                <!-- Commit Message Input -->
                <div class="mt-5">
                    <h6 class="text-light">New Commit</h6>
                        {% csrf_token %}
                        <textarea class="form-control bg-dark text-light border-secondary mb-3" name="commit_message" rows="20" required></textarea>
                        <div class="d-flex">
                            <button type="submit" name="commit_files" value="commit_files" class="btn btn-secondary me-2">Commit</button>
                            <button type="submit" name="commit_push_files" value="commit_push_files" class="btn btn-outline-secondary">Commit & Push</button>
                        </div>
                </div>
            </div>
        </form>
    </div>

    {% else %}
    <!-- Create Git Repository Section -->
    <div class="px-3 py-2">
        <h5 class="text-light">Create a Git Repository</h5>
        <hr class="border-secondary">
        <form method="post" action="">
            {% csrf_token %}
            <div class="mb-3">
                <label for="repo_name" class="form-label text-light">Repository Name</label>
                <input type="text" class="form-control bg-dark text-light border-secondary" id="repo_name" name="repo_name" value="{{ current_project.project_name }}" required>
            </div>
            <div class="mb-3">
                <label for="repo_description" class="form-label text-light">Repository Description</label>
                <textarea class="form-control bg-dark text-light border-secondary" id="repo_description" name="repo_description" rows="3">{{ current_project.project_description }}</textarea>
            </div>
            <div class="form-check mb-3">
                <input class="form-check-input" type="checkbox" id="repo_public" name="repo_public" {% if current_project.is_public %}checked {% endif %}>
                <label class="form-check-label text-light" for="repo_public">
                    Public Repository
                </label>
            </div>
            <button type="submit" name="create_git_repo" class="btn btn-secondary">Create Repository</button>
        </form>
    </div>
    {% endif %}
</div>

<!--- This is the main CodeMirror IDE section including the nave buttons--->
<form method="post" enctype="multipart/form-data" action="" class="card ide-card ide-content border-0">
    {% csrf_token %}
    <input type="hidden" name="file_path" value="{{file_path}}">
    <input type="hidden" name="file_name" value="{{file_name}}">
    <input type="hidden" name="project_id" value="{{current_project.id}}">

    <div class="card-header shadow-end border-end border-dark">
        <div class="hstack gap-1 align-middle">
            <div class="p-1">
                {% if request.user == current_project.user or request.user in current_project.collaborators.all %}
                <button class="btn folder-btn" data-bs-toggle="modal" data-bs-target="#RenameModal" type="reset">
                    <i class="bi bi-pencil"></i> {{file_name}}
                </button>
                {% else %}
                <p class="btn folder-btn">
                    <i class="bi bi-pencil"></i> {{file_name}}
                </p>
                {% endif %}
            </div>
            <div class="vr"></div>
            <div class="p-1">
                {% if request.user == current_project.user or request.user in current_project.collaborators.all %}
                <button class="btn file-item" name="save_file" type="submit" data-bs-toggle="tooltip"
            title="Save File">
                    <i class="bi bi-save fs-5 text-light"></i>
                </button>
                {% endif %}
            </div>
            <div class="p-1">
                {% if request.user == current_project.user or request.user in current_project.collaborators.all %}
                <button class="btn file-item" name="delete" type="submit" data-bs-toggle="tooltip"
            title="Delete File">
                    <i class="bi bi-trash fs-5 text-light"></i>
                </button>
                {% endif %}
            </div>
        </div>
    </div>
    <textarea name='file_contents' id="myTextarea" class="form-control">{{file_content}}</textarea>
</form>
</body>

<!-- Terminal -->
<div class="offcanvas offcanvas-bottom h-50 rounded-0 bg-transparent overflow-hidden"
     tabindex="-1"
     id="offcanvasBottom"
     aria-labelledby="offcanvasBottomLabel"
     data-bs-backdrop="false">
    <div class="card terminal p-0">
        <div class="card-header terminal-header border border-dark text-light d-flex justify-content-between align-items-center">
            <span>Terminal</span>
            <div class="ml-auto">
                <button type="button" class="btn btn-dark fs-5" data-bs-dismiss="offcanvas">
                    <i class="bi bi-dash-lg text-light"></i>
                </button>
                <button id="toggleHeightButton" class="btn btn-dark fs-5" onclick="toggleOffcanvasHeight()">
                    <i class="bi bi-arrows-fullscreen text-light"></i>
                </button>
            </div>
        </div>
        <div class="card terminal rounded-0 border p-0 text-light border-dark">
            <div class="card-body">
                <div id="terminal" class="p-1 text-light"></div>
                <div class="d-flex align-items-center">
                    <div class="prompt p-1 text-light">
                        <span class="username">user@Ubuntu</span>:<span class="path">~/{{ user }}</span>$
                    </div>
                    <input id="terminal-input" class="terminal-input border-0 text-light ms-2" autocomplete="off">
                    <input type="hidden" id="username" value="{{ user.username }}">
                    <input type="hidden" id="project-id" value="{{ current_project.id }}">
                </div>
            </div>
        </div>
    </div>
</div>

<!-- switching branch Modal -->
<div class="modal fade" id="branchModal" tabindex="-1" aria-labelledby="branchModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="branchModalLabel">Manage Branch</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
        <form>
          <div class="modal-body">
              <div class="mb-3">
                <label for="branchName" class="form-label">Branch Name</label>
                <input type="text" class="form-control bg-dark text-light" id="branchName" placeholder="Enter branch name">
              </div>
              <div class="mb-3">
                <label for="actionSelect" class="form-label">Action</label>
                <select class="form-select bg-dark text-light" id="actionSelect">
                  <option selected>Create New Branch</option>
                  <option>Switch to Existing Branch</option>
                  <option>Set Remote Branch</option>
                </select>
              </div>
              <div class="mb-3" id="remoteBranchDiv" style="display: none;">
                <label for="remoteBranch" class="form-label">Remote Branch</label>
                <input type="text" class="form-control bg-dark text-light" id="remoteBranch" placeholder="Enter remote branch">
              </div>
              </div>
          <div class="modal-footer">
            <button type="submit" name="manage_branch" class="btn btn-secondary" >Update</button>
          </div>
    </form>
    </div>
  </div>
</div>

<!-- update task modal -->
<div class="modal fade" id="updateTaskModal" tabindex="-1" aria-labelledby="updateTaskModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="updateTaskModalLabel">Update Task</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="updateTaskForm" method="post" action="">
                    {% csrf_token %}
                    <input type="hidden" name="task_id" id="task_id">
                    <div class="mb-3">
                        <label for="task_title" class="form-label">Task Title</label>
                        <input type="text" class="form-control bg-dark text-light" id="task_title" name="task_title">
                    </div>
                    <div class="mb-3">
                        <label for="task_description" class="form-label">Description</label>
                        <textarea class="form-control bg-dark text-light" id="task_description"
                                  name="task_description"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="task_status" class="form-label">Status</label>
                        <select class="form-select bg-dark text-light" id="task_status" name="task_status">
                            <option value="not_started">Not Started</option>
                            <option value="in_progress">In Progress</option>
                            <option value="completed">Completed</option>
                        </select>
                    </div>
                    <button type="submit" name="update_task" class="btn btn-primary">Save Changes</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal for changing background color and text syntax -->
<div class="modal fade" id="colorChangeModal" tabindex="-1" aria-labelledby="colorChangeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="colorChangeModalLabel">Theme and Text Syntax</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="post" enctype="multipart/form-data" action="">
                    {% csrf_token %}
                    <input type="hidden" id="selectedTheme" name="selected_theme" value="">
                    <input type="hidden" id="selectedSyntax" name="selected_syntax" value="">
                    <div class=" ms-auto">
                        <div class="dropdown">
                            <button class="btn btn-sm btn-dark dropdown-toggle" id="themeDropdown"
                                    data-bs-toggle="dropdown" aria-expanded="false" name="selected_theme">
                                Theme: <span id="currentTheme">Default</span>
                            </button>
                            <ul class="dropdown-menu" aria-labelledby="themeDropdown">
                                <li><a class="dropdown-item" onclick="changeTheme('default')">Dracula (Default)</a></li>
                                <li><a class="dropdown-item" onclick="changeTheme('monokai')">Monokai</a></li>
                                <li><a class="dropdown-item" onclick="changeTheme('ayu-dark')">Ayu Dark</a></li>
                                <li><a class="dropdown-item" onclick="changeTheme('light-mode')">Light Mode</a></li>
                                <li><a class="dropdown-item" onclick="changeTheme('eclipse')">Eclipse</a></li>
                                <li><a class="dropdown-item" onclick="changeTheme('solarized-light')">Solarized Light</a></li>
                            </ul>
                        </div>
                    </div>
                    <div class="p-2">
                        <div class="dropdown">
                            <button class="btn btn-sm btn-dark dropdown-toggle" type="button" id="syntaxDropdown"
                                    data-bs-toggle="dropdown" aria-expanded="false">
                                Syntax Highlighting: <span id="currentSyntax">Auto Detect</span>
                            </button>
                            <ul class="dropdown-menu" aria-labelledby="syntaxDropdown">
                                <li><a class="dropdown-item" href="#" onclick="changeSyntax('autodetect')">Auto Detect</a></li>
                                <li><a class="dropdown-item" href="#" onclick="changeSyntax('plain')">Plain Text</a></li>
                                <li><a class="dropdown-item" href="#" onclick="changeSyntax('python')">Python</a></li>
                                <li><a class="dropdown-item" href="#" onclick="changeSyntax('javascript')">JavaScript</a></li>
                                <li><a class="dropdown-item" href="#" onclick="changeSyntax('html')">HTML</a></li>
                                <li><a class="dropdown-item" href="#" onclick="changeSyntax('css')">CSS</a></li>
                                <li><a class="dropdown-item" href="#" onclick="changeSyntax('java')">Java</a></li>
                                <li><a class="dropdown-item" href="#" onclick="changeSyntax('c')">C</a></li>
                                <li><a class="dropdown-item" href="#" onclick="changeSyntax('cpp')">CPP</a></li>
                                <li><a class="dropdown-item" href="#" onclick="changeSyntax('php')">PHP</a></li>
                                <li><a class="dropdown-item" href="#" onclick="changeSyntax('ruby')">Ruby</a></li>
                                <li><a class="dropdown-item" href="#" onclick="changeSyntax('swift')">Swift</a></li>
                                <li><a class="dropdown-item" href="#" onclick="changeSyntax('go')">Go</a></li>
                                <li><a class="dropdown-item" href="#" onclick="changeSyntax('rust')">Rust</a></li>
                                <li><a class="dropdown-item" href="#" onclick="changeSyntax('typescript')">TypeScript</a></li>
                                <!-- Add more syntax highlighting options as needed -->
                            </ul>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" name="update_theme" class="btn btn-secondary">Apply Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal for renaming file-->
<div class="modal fade modal-dark" id="renameModal" tabindex="-1" aria-labelledby="renameModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content text-light">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="renameModalLabel">Rename</h1>
            </div>
            <form method="post" enctype="multipart/form-data"
                  action="{% url 'ide' username=current_project.user.username project_id=current_project.id %}"
                  class="modal-body">
                {% csrf_token %}
                <input type="text" name="new_file_name" value="{{ file_name }}"
                       class="form-control bg-dark text-light border-secondary mb-4">
                <input type="hidden" name="file_path" value="{{ file_path }}">
                <input type="hidden" name="file_contents" value="{{ file_content }}">
                <input type="hidden" name="project_id" value="{{ current_project.id }}">
                <button type="submit" name="rename_file" class="btn btn-secondary">Save changes</button>
            </form>
        </div>
    </div>
</div>

<!-- Toast container -->
<div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 10000;">
    {% if messages %}
        {% for message in messages %}
            <div class="toast align-items-center text-bg-dark border-0 mb-2" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="d-flex">
                    <div class="toast-body">
                        {{ message }}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            </div>
        {% endfor %}
    {% endif %}
</div>


<!-- Bootstrap Bundle with Popper -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<!-- CodeMirror js and css -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.0/codemirror.min.css">
<!-- JavaScript -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.0/codemirror.min.js"></script>

<!-- Here are all the links to the different syntax highlighting for CodeMirror -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.0/mode/plain/plain.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.0/addon/mode/multiplex.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.0/mode/python/python.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.0/mode/javascript/javascript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.0/mode/htmlmixed/htmlmixed.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.0/mode/css/css.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.0/mode/clike/clike.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.0/mode/php/php.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.0/mode/ruby/ruby.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.0/mode/swift/swift.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.0/mode/go/go.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.0/mode/rust/rust.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.0/mode/typescript/typescript.min.js"></script>

<!-- Here are all the links to the different themes for CodeMirror -->

<!-- Eclipse -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.0/theme/eclipse.min.css">
<!-- Solarized -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.0/theme/solarized.min.css">
<!-- Monokai -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.0/theme/monokai.min.css">
<!-- Dracula -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.0/theme/dracula.min.css">
<!-- Ayu Dark -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.0/theme/ayu-dark.min.css">
<!-- Default -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.0/theme/default.min.css">



<!-- toggle checkboxes based on "select-all" checkbox -->
<script>
    // Function to toggle checkboxes based on "select-all" checkbox
    function toggleCheckboxes(sectionId, selectAllCheckboxId) {
        const selectAllCheckbox = document.getElementById(selectAllCheckboxId);
        const checkboxes = document.querySelectorAll(`#${sectionId} input[type="checkbox"]`);
        checkboxes.forEach(checkbox => {
            checkbox.checked = selectAllCheckbox.checked;
        });
    }

    document.getElementById('select-all-files-untracked').addEventListener('change', function() {
        toggleCheckboxes('uncommitted-files-untracked-section', 'select-all-files-untracked');
    });

    document.getElementById('select-all-files-tracked').addEventListener('change', function() {
        toggleCheckboxes('uncommitted-files-tracked-section', 'select-all-files-tracked');
    });
</script>

<!-- Toast JS -->
<script>
    var toastElements = document.querySelectorAll('.toast');
    toastElements.forEach(function(toastElement) {
        var toast = new bootstrap.Toast(toastElement);
        toast.show();
    });
</script>

<!-- IDE js logic -->
<script>
    // Store the collapse state in an object
    let collapseState = {};

    // Function to update the project tree
    function updateProjectTree() {
        document.querySelectorAll('.collapse').forEach(collapseElement => {
            const id = collapseElement.id;
            collapseState[id] = collapseElement.classList.contains('show');
        });

        const filesSidebar = document.querySelector('#filesSidebar');
        const scrollPosition = filesSidebar.scrollTop;

        fetch(window.location.href, {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.project_tree) {
                const treeContainer = document.querySelector('#filesSidebar ul');
                treeContainer.innerHTML = '';
                const treeHTML = generateTreeHTML(data.project_tree);
                treeContainer.innerHTML = treeHTML;

                document.querySelectorAll('.collapse').forEach(collapseElement => {
                    const id = collapseElement.id;
                    if (collapseState[id]) {
                        collapseElement.classList.add('show');
                    } else {
                        collapseElement.classList.remove('show');
                    }
                });

                document.querySelectorAll('.btn.folder-btn').forEach(button => {
                    const targetCollapse = document.querySelector(button.getAttribute('data-bs-target'));
                    if (targetCollapse && targetCollapse.classList.contains('show')) {
                        button.setAttribute('aria-expanded', 'true');
                    } else {
                        button.setAttribute('aria-expanded', 'false');
                    }
                });

                filesSidebar.scrollTop = scrollPosition;
            }
        })
        .catch(error => console.error('Error fetching project tree:', error));
    }

    function generateTreeHTML(nodes) {
        let html = '';
        nodes.forEach(node => {
            if (node.type === 'directory') {
                html += `<li>
                            <button class="btn btn-sm folder-btn" type="button" data-bs-toggle="collapse"
                                    data-bs-target="#${slugify(node.name)}" aria-expanded="false">
                                <i class="bi bi-folder"></i><i class="bi bi-folder-minus d-none"></i> ${node.name}
                            </button>
                            <ul class="collapse list-unstyled ms-4" id="${slugify(node.name)}">
                                ${generateTreeHTML(node.children)}
                            </ul>
                          </li>`;
            } else if (node.type === 'file') {
                html += `<li>
                            <button class="btn btn-sm file-item" name="open_file" value="${node.path}" type="submit">
                                <i class="bi bi-file-earmark-code"></i> ${node.name}
                            </button>
                          </li>`;
            }
        });
        return html;
    }

    function slugify(text) {
        return text.toLowerCase().replace(/\s+/g, '-').replace(/[^\w\-]+/g, '');
    }
</script>

<!-- Sidebar toggle js logic -->
<script>
    document.addEventListener("DOMContentLoaded", () => {
        const sidebarCollapse = document.getElementById("sidebarCollapse");
        const taskSidebarCollapse = document.getElementById("taskSidebarCollapse");
        const gitSidebarCollapse = document.getElementById("gitSidebarCollapse");
        const filesSidebar = document.getElementById("filesSidebar");
        const tasksSidebar = document.getElementById("tasksSidebar");
        const gitCommitsSidebar = document.getElementById("gitCommitsSidebar");
        const body = document.body;

        sidebarCollapse.addEventListener("click", () => {
            filesSidebar.classList.toggle("active");
            tasksSidebar.classList.remove("active");
            gitCommitsSidebar.classList.remove("active");
            updateLayoutClasses();
        });

        taskSidebarCollapse.addEventListener("click", () => {
            tasksSidebar.classList.toggle("active");
            filesSidebar.classList.remove("active");
            gitCommitsSidebar.classList.remove("active");
            updateLayoutClasses();
        });

        gitSidebarCollapse.addEventListener("click", () => {
            gitCommitsSidebar.classList.toggle("active");
            filesSidebar.classList.remove("active");
            tasksSidebar.classList.remove("active");
            updateLayoutClasses();
        });

        function updateLayoutClasses() {
            const isFilesSidebarActive = filesSidebar.classList.contains("active");
            const isTasksSidebarActive = tasksSidebar.classList.contains("active");
            const isGitCommitsSidebarActive = gitCommitsSidebar.classList.contains("active");

            body.classList.remove("files-sidebar-active", "tasks-sidebar-active", "git-commits-sidebar-active", "both-sidebars-active");

            if (isFilesSidebarActive && isTasksSidebarActive && isGitCommitsSidebarActive) {
                body.classList.add("both-sidebars-active");
            } else if (isFilesSidebarActive) {
                body.classList.add("files-sidebar-active");
            } else if (isTasksSidebarActive) {
                body.classList.add("tasks-sidebar-active");
            } else if (isGitCommitsSidebarActive) {
                body.classList.add("git-commits-sidebar-active");
            }
        }
    });
</script>

<!-- task model js logic -->
<script>
    // Populate Modal with task details
    document.addEventListener('DOMContentLoaded', () => {
        const updateTaskModal = document.getElementById('updateTaskModal');
        updateTaskModal.addEventListener('show.bs.modal', (event) => {
            const button = event.relatedTarget;
            const taskId = button.getAttribute('data-task-id');
            const taskTitle = button.getAttribute('data-task-title');
            const taskDescription = button.getAttribute('data-task-description');
            const taskStatus = button.getAttribute('data-task-status');

            document.getElementById('task_id').value = taskId;
            document.getElementById('task_title').value = taskTitle;
            document.getElementById('task_description').value = taskDescription;
            document.getElementById('task_status').value = taskStatus;
        });
    });
</script>

<script>
    // Update the project tree every 3 seconds
    setInterval(updateProjectTree, 3000);
</script>

<!-- update CodeMirror theme js logic -->
<script>
    var editor;
    function changeTheme(theme) {
        editor.setOption("theme", theme);
        document.getElementById('currentTheme').textContent = theme.charAt(0).toUpperCase() + theme.slice(1);
        document.getElementById('selectedTheme').value = theme;
    }

    function changeSyntax(mode) {
        editor.setOption("mode", mode);
        document.getElementById('currentSyntax').textContent = mode.charAt(0).toUpperCase() + mode.slice(1);
        document.getElementById('selectedSyntax').value = mode;
    }

    document.addEventListener("DOMContentLoaded", function () {
        editor = CodeMirror.fromTextArea(document.getElementById("myTextarea"), {
            lineNumbers: true,
            mode: "autodetect",
            theme: "default",
            autoCloseBrackets: true,
            matchBrackets: true
        });
        editor.setSize(null, "100%");

        var initialTheme = "{{ request.user.ide_settings.selected_theme }}";
        var initialSyntax = "{{ request.user.ide_settings.selected_syntax }}";

        if (initialTheme !== "default") {
            changeTheme(initialTheme);
        }
        if (initialSyntax !== "auto") {
            changeSyntax(initialSyntax);
        }
    });
</script>

<!-- terminal expand collapse js logic -->
<script>
    // Toggle offcanvas height between 50% and 100%
    function toggleOffcanvasHeight() {
        const offcanvasElement = document.getElementById('offcanvasBottom');
        if (offcanvasElement.classList.contains('h-50')) {
            offcanvasElement.classList.remove('h-50');
            offcanvasElement.classList.add('h-100');
        } else {
            offcanvasElement.classList.remove('h-100');
            offcanvasElement.classList.add('h-50');
        }
    }
</script>

<!-- terminal websocket js logic -->
<script>
    // WebSocket logic for terminal interaction
    let socket;
    let commandHistory = [];
    let historyIndex = -1;

    function initWebSocket(username, projectId) {
        const socketUrl = `ws://209.38.78.211:8000/ws/ide/${username}/${projectId}/`;
        socket = new WebSocket(socketUrl);

        socket.onopen = function() {
            console.log("WebSocket connection established.");
        };

        socket.onmessage = function(event) {
            const data = JSON.parse(event.data);

            if (data.type === 'terminal_output') {
                const terminalDiv = document.getElementById('terminal');
                const formattedResponse = data.output
                    .split('\n')
                    .map(line => `<div><span class="output">${line}</span></div>`)
                    .join('');

                terminalDiv.innerHTML += formattedResponse;
                terminalDiv.scrollTop = terminalDiv.scrollHeight;
            }

            if (data.type === 'terminal_error') {
                const terminalDiv = document.getElementById('terminal');
                const errorResponse = `<div><span class="error">${data.error}</span></div>`;
                terminalDiv.innerHTML += errorResponse;
                terminalDiv.scrollTop = terminalDiv.scrollHeight;
            }
        };

        socket.onerror = function(error) {
            console.error("WebSocket Error:", error);
        };

        socket.onclose = function(event) {
            console.log("WebSocket connection closed:", event);
        };
    }

    function sendPrompt() {
        const promptValue = document.querySelector('.terminal-input').value.trim();
        if (!promptValue) return;

        commandHistory.push(promptValue);
        historyIndex = commandHistory.length;

        const terminalDiv = document.getElementById('terminal');

        terminalDiv.innerHTML += `<div>
            <span class="username">user@Ubuntu</span>:<span class="path">~/{{user}}</span>$ ${promptValue}
        </div>`;

        if (promptValue.toLowerCase() === 'clear') {
            terminalDiv.innerHTML = '';
            document.querySelector('.terminal-input').value = '';
            return;
        }

        if (socket && socket.readyState === WebSocket.OPEN) {
            socket.send(JSON.stringify({
                'command': promptValue
            }));
        } else {
            console.error("WebSocket is not open.");
        }

        document.querySelector('.terminal-input').value = '';
    }

    document.querySelector('.terminal-input').addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            sendPrompt();
        } else if (e.key === 'ArrowUp') {
            if (historyIndex > 0) historyIndex--;
            e.target.value = commandHistory[historyIndex] || '';
            e.preventDefault();
        } else if (e.key === 'ArrowDown') {
            if (historyIndex < commandHistory.length - 1) historyIndex++;
            e.target.value = commandHistory[historyIndex] || '';
            e.preventDefault();
        }
    });

    document.addEventListener('DOMContentLoaded', function() {
        const username = document.getElementById('username').value;
        const projectId = document.getElementById('project-id').value;
        initWebSocket(username, projectId);
    });
</script>

</html>