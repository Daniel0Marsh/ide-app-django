<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %} {{project.project_name}}/{{file.file_name}} {% endblock %}</title>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <!-- Bootstrap Icons CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">

    {% load static %}
    <link rel="stylesheet" type="text/css" href="{% static 'ide.css' %}">
    <script src="{% static ide.js %}"></script>

</head>

<nav class="navbar navbar-expand-lg navbar-dark border-bottom bg-dark">
    <div class="container-fluid">
        <div class="d-flex justify-content-center mx-auto folder-btn">
            <button class="btn btn-lg folder-btn" data-bs-toggle="modal" data-bs-target="#RenameModal" type="reset">
                <i class="bi bi-pencil"></i> {{project.project_name}}/{{file.file_name}}
            </button>
        </div>
    </div>
</nav>

<body>

<!-- project side-nav -->
<div class="side-nav shadow-end border-end border-dark bg-dark">
    <button type="button" id="sidebarCollapse" class="btn btn-dark mx-auto mb-4">
        <i class="bi bi-tree fs-2 text-light"></i>
    </button>

    <button type="button" class="btn btn-dark mx-auto mb-4" data-bs-toggle="modal" data-bs-target="#createDirModal">
        <i class="bi bi-folder-plus fs-2 text-light"></i>
    </button>

    <button type="button" class="btn btn-dark mx-auto mb-4" data-bs-toggle="modal" data-bs-target="#DeleteModal">
        <i class="bi bi-trash fs-2 text-light"></i>
    </button>

    <button type="button" class="btn btn-dark mx-auto mb-4">
        <i class="bi bi-download fs-2 text-light"></i>
    </button>
</div>

<!-- project tree -->
<form method="post" enctype="multipart/form-data" action="{% url 'project' %}" class="sidebar active shadow-end border-end border-dark" id="sidebar">
    {% csrf_token %}
    <input type="hidden" name="project_id" value="{{project.id}}">
    <ul>
        <!-- Project -->
        <li>
            <button class="btn btn-sm folder-btn" type="button" data-bs-toggle="collapse" data-bs-target="#project"
                    aria-expanded="true">
                <i class="bi bi-folder-plus"></i><i class="bi bi-folder-minus d-none"></i> {{project.project_name}}
            </button>
            <ul class="collapse show" id="project">
                {% for directory in project.directories.all %}
                {% if not directory.parent_directory %}
                <li>
                    <button class="btn btn-sm folder-btn" type="button" data-bs-toggle="collapse"
                            data-bs-target="#{{ directory.directory_name|slugify }}" aria-expanded="false">
                        <i class="bi bi-folder-plus"></i><i class="bi bi-folder-minus d-none"></i>
                        {{directory.directory_name}}
                    </button>
                    <ul class="collapse" id="{{directory.directory_name|slugify}}">
                        <!-- Render Subdirectories -->
                        {% for subdirectory in directory.subdirectories.all %}
                        <li>
                            <button class="btn btn-sm folder-btn" type="button" data-bs-toggle="collapse"
                                    data-bs-target="#{{subdirectory.directory_name|slugify}}"
                                    aria-expanded="false">
                                <i class="bi bi-folder-plus"></i><i class="bi bi-folder-minus d-none"></i>
                                {{subdirectory.directory_name}}
                            </button>
                            <ul class="collapse" id="{{subdirectory.directory_name|slugify}}">
                                <!-- Render Files -->
                                {% for file in subdirectory.files.all %}
                                <li>
                                    <button class="btn btn-sm file-item" name="open_file" value="{{file.id}}"
                                            type="submit">
                                        <i class="bi bi-arrow-return-right"></i> {{file.file_name}}
                                    </button>
                                </li>
                                {% endfor %}
                            </ul>
                        </li>
                        {% endfor %}
                        <!-- Render Files for Directory -->
                        {% for file in directory.files.all %}
                        <li>
                            <button class="btn btn-sm file-item" name="open_file" value="{{file.id}}" type="submit">
                                <i class="bi bi-arrow-return-right"></i> {{file.file_name}}
                            </button>
                        </li>
                        {% endfor %}
                    </ul>
                </li>
                {% endif %}
                {% endfor %}
                {% for file in project.files.all %}
                <li>
                    <button class="btn btn-sm file-item" name="open_file" value="{{file.id}}" type="submit">
                        <i class="bi bi-arrow-return-right"></i> {{file.file_name}}
                    </button>
                </li>
                {% endfor %}
            </ul>
        </li>
    </ul>
</form>


<!--- This is the main CodeMirror IDE section including the nave buttons--->
<form method="post" enctype="multipart/form-data" action="{% url 'project' %}" class="card ide-card border-0">
    {% csrf_token %}
    <input type="hidden" name="project_id" value="{{ project.id }}">
    <input type="hidden" name="item_id" value="{{file.id}}">
    <input type="hidden" name="file_name" value="{{file.file_name}}">

    <input type="hidden" id="selectedThemeInput" name="selected_theme" value="default">
    <input type="hidden" id="selectedSyntaxInput" name="selected_syntax" value="auto">

    <div class="card-header">
        <div class="row">
            <div class="col">
                <button class="btn folder-btn" data-bs-toggle="modal" data-bs-target="#RenameModal" type="reset">
                    <i class="bi bi-pencil"></i> {{file.file_name}}
                </button>
            </div>
            <div class="col">
                <button class="btn file-item" name="save_file" type="submit">
                    <i class="bi bi-save"></i> Save
                </button>
            </div>
            <div class="col">
                <button class="btn file-item" name="delete" type="submit">
                    <i class="bi bi-trash"></i> Delete
                </button>
            </div>
            <!-- Add dropdown buttons -->
            <div class="col">
                <div class="dropdown">
                    <button class="btn btn-secondary dropdown-toggle" id="themeDropdown"
                            data-bs-toggle="dropdown" aria-expanded="false">
                        Theme: <span id="currentTheme">Default</span>
                    </button>
                    <ul class="dropdown-menu" aria-labelledby="themeDropdown">
                        <li><a class="dropdown-item" onclick="changeTheme('default')">Light Mode</a></li>
                        <li><a class="dropdown-item" onclick="changeTheme('eclipse')">Eclipse</a></li>
                        <li><a class="dropdown-item" onclick="changeTheme('material')">Material</a></li>
                        <li><a class="dropdown-item" onclick="changeTheme('cobalt')">Cobalt</a></li>
                        <li><a class="dropdown-item" onclick="changeTheme('monokai')">Monokai</a></li>
                        <li><a class="dropdown-item" onclick="changeTheme('dracula')">Dracula</a></li>
                        <!-- Add more themes as needed -->
                    </ul>
                </div>
            </div>
            <div class="col">
                <div class="dropdown">
                    <button class="btn btn-secondary dropdown-toggle" type="button" id="syntaxDropdown"
                            data-bs-toggle="dropdown" aria-expanded="false">
                        Syntax Highlighting: <span id="currentSyntax">Auto</span>
                    </button>
                    <ul class="dropdown-menu" aria-labelledby="syntaxDropdown">
                        <li><a class="dropdown-item" href="#" onclick="changeSyntax('auto')">Auto Detect</a></li>
                        <li><a class="dropdown-item" href="#" onclick="changeSyntax('plain')">Plain Text</a></li>
                        <li><a class="dropdown-item" href="#" onclick="changeSyntax('python')">Python</a></li>
                        <li><a class="dropdown-item" href="#" onclick="changeSyntax('javascript')">JavaScript</a></li>
                        <li><a class="dropdown-item" href="#" onclick="changeSyntax('html')">HTML</a></li>
                        <li><a class="dropdown-item" href="#" onclick="changeSyntax('css')">CSS</a></li>
                        <li><a class="dropdown-item" href="#" onclick="changeSyntax('java')">Java</a></li>
                        <li><a class="dropdown-item" href="#" onclick="changeSyntax('c')">C</a></li>
                        <li><a class="dropdown-item" href="#" onclick="changeSyntax('cpp')">C++</a></li>
                        <li><a class="dropdown-item" href="#" onclick="changeSyntax('php')">PHP</a></li>
                        <li><a class="dropdown-item" href="#" onclick="changeSyntax('ruby')">Ruby</a></li>
                        <li><a class="dropdown-item" href="#" onclick="changeSyntax('swift')">Swift</a></li>
                        <li><a class="dropdown-item" href="#" onclick="changeSyntax('go')">Go</a></li>
                        <li><a class="dropdown-item" href="#" onclick="changeSyntax('rust')">Rust</a></li>
                        <li><a class="dropdown-item" href="#" onclick="changeSyntax('typescript')">TypeScript</a></li>
                        <!-- Add more syntax highlighting options as needed -->
                    </ul>
                </div>
            </div>
        </div>
    </div>
    <textarea name='contents' id="myTextarea">{{ file.contents|safe }}</textarea>
</form>
</body>


<!-- Modal for renaming file-->
<div class="modal fade modal-dark" id="renameModal" tabindex="-1" aria-labelledby="renameModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="renameModalLabel">Rename...</h1>
            </div>
            <form method="post" enctype="multipart/form-data" action="{% url 'project' %}" class="modal-body">
                {% csrf_token %}
                <input type="text" name="file_name" value="{{file.file_name}}"
                       class="form-control bg-dark text-light border-secondary mb-4">
                <input type="hidden" name="project_id" value="{{ project.id }}">
                <input type="hidden" name="item_id" value="{{file.id}}">
                <input type="hidden" name="contents" value="{{file.contents|safe}}">
                <select name="item_id" class="form-control bg-dark text-light border-secondary mb-4">
                    <option value="">/{{project.project_name}}</option>
                    {% for directory in project.directories.all %}
                    <option value="{{ directory.id }}">/{{project.project_name}}/{{directory.directory_name}}
                    </option>
                    {% endfor %}
                    {% for subdirectory in directory.subdirectories.all %}
                    <option value="{{ subdirectory.id }}">
                        {{project.project_name}}/{{directory.directory_name}}/{{subdirectory.directory_name}}
                    </option>
                    {% endfor %}
                    {% for file in project.files.all %}
                    <option value="{{ file.id }}">/{{project.project_name}}/{{ file.file_name}}</option>
                    {% endfor %}
                    {% for file in subdirectory.files.all %}
                    <option value="{{ file.id }}">
                        {{project.project_name}}/{{directory.directory_name}}/{{file.file_name}}
                    </option>
                    {% endfor %}
                </select>
                <button type="submit" name="rename_file" class="btn btn-primary">Save changes</button>
            </form>
        </div>
    </div>
</div>

<!-- Modal for creating files & directory -->
<div class="modal fade modal-dark" id="createDirModal" tabindex="-1" aria-labelledby="createDirModalLabel"
     aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="createDirModalLabel">Create File or Directory</h1>
            </div>
            <form method="post" enctype="multipart/form-data" action="{% url 'project' %}" class="modal-body">
                {% csrf_token %}
                <input type="text" name="item_name" placeholder="Directory Name"
                       class="form-control bg-dark text-light border-secondary mb-4">
                <input type="hidden" name="project_id" value="{{project.id}}">
                <select name="parent_dir" class="form-control bg-dark text-light border-secondary mb-4">
                    <option value="">/{{project.project_name}}</option>
                    {% for directory in project.directories.all %}
                    <option value="{{ directory.id }}">/{{project.project_name}}/{{directory.directory_name}}</option>
                    {% endfor %}
                    {% for subdirectory in directory.subdirectories.all %}
                    <option value="{{ subdirectory.id }}">
                        {{project.project_name}}/{{directory.directory_name}}/{{subdirectory.directory_name}}
                    </option>
                    {% endfor %}
                </select>
                <button type="submit" name="create_file" class="btn btn-primary">Create File</button>
                <button type="submit" name="create_dir" class="btn btn-warning">Create Directory</button>
            </form>
        </div>
    </div>
</div>


<!-- Modal for deleting files & directories -->
<div class="modal fade modal-dark" id="DeleteModal" tabindex="-1" aria-labelledby="DeleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="DeleteModalLabel">Delete File or Directory</h1>
            </div>
            <form method="post" enctype="multipart/form-data" action="{% url 'project' %}" class="modal-body">
                {% csrf_token %}
                <input type="hidden" name="project_id" value="{{ project.id }}">
                <select name="item_id" class="form-control bg-dark text-light border-secondary mb-4">
                    <option value="">/{{project.project_name}}</option>
                    {% for directory in project.directories.all %}
                    <option value="{{ directory.id }}">/{{project.project_name}}/{{directory.directory_name}}
                    </option>
                    {% endfor %}
                    {% for subdirectory in directory.subdirectories.all %}
                    <option value="{{ subdirectory.id }}">
                        {{project.project_name}}/{{directory.directory_name}}/{{subdirectory.directory_name}}
                    </option>
                    {% endfor %}
                    {% for file in project.files.all %}
                    <option value="{{ file.id }}">/{{project.project_name}}/{{ file.file_name}}</option>
                    {% endfor %}
                    {% for file in subdirectory.files.all %}
                    <option value="{{ file.id }}">
                        {{project.project_name}}/{{directory.directory_name}}/{{file.file_name}}
                    </option>
                    {% endfor %}
                </select>
                <button type="submit" name="delete" class="btn btn-primary">Delete</button>
            </form>
        </div>
    </div>
</div>



<!-- Bootstrap Bundle with Popper -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<!-- CodeMirror js and css -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.0/codemirror.min.css">
<!-- JavaScript -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.0/codemirror.min.js"></script>

<!-- Here are all the links to the different syntax highlighting for CodeMirror -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.0/mode/plain/plain.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.0/addon/mode/multiplex.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.0/mode/python/python.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.0/mode/javascript/javascript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.0/mode/htmlmixed/htmlmixed.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.0/mode/css/css.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.0/mode/clike/clike.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.0/mode/php/php.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.0/mode/ruby/ruby.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.0/mode/swift/swift.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.0/mode/go/go.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.0/mode/rust/rust.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.0/mode/typescript/typescript.min.js"></script>

<!-- Here are all the links to the different themes for CodeMirror -->
<!-- Dracula Theme CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.0/theme/dracula.min.css">
<!-- Monokai Theme CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.0/theme/monokai.min.css">
<!-- Material Theme CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.0/theme/material.min.css">
<!-- Cobalt Theme CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.0/theme/cobalt.min.css">
<!-- Eclipse Theme CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.0/theme/eclipse.min.css">

<script>
    var editor;

    function changeTheme(theme) {
        editor.setOption("theme", theme);
        // Update the button text to display the current theme
        document.getElementById('currentTheme').textContent = theme.charAt(0).toUpperCase() + theme.slice(1);
        // Update the hidden input field to store the selected theme
        document.getElementById('selectedThemeInput').value = theme;
    }

    function changeSyntax(mode) {
        editor.setOption("mode", mode);
        // Update the button text to display the current syntax
        document.getElementById('currentSyntax').textContent = mode.charAt(0).toUpperCase() + mode.slice(1);
        // Update the hidden input field to store the selected syntax
        document.getElementById('selectedSyntaxInput').value = mode;
    }

    document.addEventListener("DOMContentLoaded", function () {
        editor = CodeMirror.fromTextArea(document.getElementById("myTextarea"), {
            lineNumbers: true,
            mode: "auto", // Default mode
            theme: "default", // Default theme
            autoCloseBrackets: true, // Optional, enables bracket matching
            matchBrackets: true // Optional, enables bracket matching
        });
        editor.setSize(null, "100%");

        // Get the initial theme value from the model
        var initialTheme = "{{ project.selected_theme }}";
        // Get the initial syntax value from the model
        var initialSyntax = "{{ project.selected_syntax }}";

        // Update the theme if it's not the default theme
        if (initialTheme !== "default") {
            changeTheme(initialTheme);
        }
        // Update the syntax if it's not the default syntax
        if (initialSyntax !== "auto") {
            changeSyntax(initialSyntax);
        }
    });

    // Toggle sidebar
    document.getElementById("sidebarCollapse").addEventListener("click", function () {
        document.getElementById("sidebar").classList.toggle("active");
    });

    // Add event listeners to toggle folder icons
    document.querySelectorAll('.collapse').forEach(function(collapse) {
        collapse.addEventListener('show.bs.collapse', function() {
            this.previousElementSibling.querySelector('.bi-folder-plus').classList.add('d-none');
            this.previousElementSibling.querySelector('.bi-folder-minus').classList.remove('d-none');
        });

        collapse.addEventListener('hide.bs.collapse', function() {
            this.previousElementSibling.querySelector('.bi-folder-plus').classList.remove('d-none');
            this.previousElementSibling.querySelector('.bi-folder-minus').classList.add('d-none');
        });
    });
</script>


</html>
